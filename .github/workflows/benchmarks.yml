name: Benchmarks

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1" # Weekly on Monday at 06:00 UTC

defaults:
  run:
    working-directory: go

jobs:
  micro-benchmarks:
    name: Micro-benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Run micro-benchmarks
        run: |
          go test -bench=. -benchmem ./pkg/crypto/... ./pkg/lsh/... 2>&1 | tee bench-output.txt

      - name: Summary
        run: |
          echo "## Micro-benchmarks" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          grep -E "^Benchmark|^ok" bench-output.txt >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/upload-artifact@v4
        with:
          name: micro-benchmarks
          path: go/bench-output.txt

  accuracy-sift10k:
    name: SIFT10K accuracy
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Download SIFT10K dataset
        run: |
          mkdir -p testdata/siftsmall
          curl -sL ftp://ftp.irisa.fr/local/texmex/corpus/siftsmall.tar.gz | tar xz -C testdata/

      - name: Run SIFT10K accuracy test
        run: |
          go test -v -run TestSIFTKMeansEndToEnd ./pkg/client/ -timeout 5m 2>&1 | tee sift-output.txt

      - name: Summary
        run: |
          echo "## SIFT10K Accuracy" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          grep -E "recall|Recall|PASS|FAIL" sift-output.txt >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/upload-artifact@v4
        with:
          name: sift10k-results
          path: go/sift-output.txt

  benchmark-100k:
    name: 100K vector benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Run 100K benchmark
        run: |
          go test -v -run TestBenchmark100KOptimized ./pkg/client/ -timeout 15m 2>&1 | tee 100k-output.txt

      - name: Summary
        run: |
          echo "## 100K Vector Benchmark" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          grep -E "latency|recall|Recall|Latency|PASS|FAIL|benchmark" 100k-output.txt >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/upload-artifact@v4
        with:
          name: benchmark-100k-results
          path: go/100k-output.txt

  accuracy-sift1m:
    name: SIFT1M accuracy
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: go/go.sum

      - name: Cache SIFT1M dataset
        id: cache-sift1m
        uses: actions/cache@v4
        with:
          path: data/sift
          key: sift1m-dataset-v1

      - name: Download SIFT1M dataset
        if: steps.cache-sift1m.outputs.cache-hit != 'true'
        run: |
          mkdir -p ../data/sift
          curl -fSL ftp://ftp.irisa.fr/local/texmex/corpus/sift.tar.gz -o /tmp/sift.tar.gz
          tar xzf /tmp/sift.tar.gz -C ../data/sift --strip-components=1
          rm -f /tmp/sift.tar.gz

      - name: Run SIFT1M accuracy benchmark
        run: |
          go test -v -tags sift1m -run TestSIFT1MAccuracy ./test/ -timeout 45m 2>&1 | tee sift1m-output.txt

      - name: Run SIFT1M scaling benchmark
        run: |
          go test -v -tags sift1m -run TestSIFT1MScaling ./test/ -timeout 45m 2>&1 | tee -a sift1m-output.txt

      - name: Summary
        if: always()
        run: |
          echo "## SIFT1M Benchmark" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          grep -E "Recall|recall|Latency|latency|Build|PASS|FAIL|SCALING|vectors" sift1m-output.txt >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sift1m-results
          path: go/sift1m-output.txt
